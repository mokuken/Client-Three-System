<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        height: 100vh;
        background-image: url("{{ url_for('static', filename='images/base-bg.png') }}");
        background-size: cover;
        background-position: center;
        background-attachment: fixed; /* keeps it frozen while scrolling */
    }
    .navbar {
        background-color: #fff;
        color: #000;
        height: 10vh;
        padding: 10px 20px;
        position: sticky;
        top: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .brand {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user {
        display: flex;
        align-items: center;
    }

    .main {
        display: flex;
        justify-content: center;
        padding: 20px;
    }
    .container {
        width: 60%;
    }

    .position-header {
        margin: 15px 0;
        color: #fff;
    }

    .candidates {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2 equal columns */
        gap: 20px; /* space between boxes */
        margin: auto;
        margin-bottom: 40px;
    }
    .candidate {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        font-size: 18px;
    position: relative; /* containing block for absolutely positioned .voted */
    }

    .vote-btn {
        width: 100%;
        padding: 10px 20px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }

    /* make sure the vote button sits at the bottom of the card
       even when some content (like party) is missing */
    .candidates .candidate {
        display: flex;            /* ensure flex in case specificity changed */
        flex-direction: column;
        justify-content: flex-start; /* default, let button push with auto margin */
        height: 100%;
        min-height: 240px;        /* give cards consistent height */
    }

    .vote-btn {
        margin-top: auto; /* push button to bottom of the card */
    }

    .voted {
        display: flex;
        align-items: center;
        gap: 10px;
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(255,255,255,0.9); /* subtle background so it reads over content */
        padding: 4px 8px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .cancel-vote-btn {
        width: 100%;
        padding: 10px 20px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }
    /* floating review button */
    .review-btn {
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: #007bff;
        color: #fff;
        padding: 12px 16px;
        border-radius: 28px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.18);
        border: none;
        cursor: pointer;
        font-weight: 600;
        z-index: 2000;
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }
    .review-btn img { width: 18px; height: 18px; }
</style>
<body data-election-id="{{ election.id if election else '' }}" data-submit-url="{{ url_for('voter_submit_votes') }}" data-select-url="{{ url_for('voter_select') }}">
    <div class="navbar">
        <div class="brand">
            <img src="{{ url_for('static', filename='images/logo.png') }}" style="width: 50px;" alt="Logo" class="logo">
            <div class="brand-name">
                <h3>Vicente Andaya Senior National High School</h3>
                <h4>Online Voting System</h4>
            </div>
        </div>
        <div class="user">
            <img src="{{ url_for('static', filename='images/profile.png') }}" style="width: 30px; border-radius: 50%;" alt="User" class="user-icon">
            <span class="username" style="margin-left: 10px;">John Doe</span>
            <div class="logout">
                <form id="logoutFormVote" method="post" action="{{ url_for('logout') }}" style="display:inline; margin-left:15px;">
                    <button type="submit" style="padding: 10px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; display:inline-flex; align-items:center; gap:6px;">
                        <img src="{{ url_for('static', filename='images/logout.png') }}" style="width: 16px; vertical-align: middle; margin-right: 5px;" alt="Logout Icon">
                        Logout
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
    <div class="main">
        <div class="container">
            {% if election and positions and positions|length > 0 %}
                <div style="padding: 18px; border-radius:12px;">
                    <div style="background-color: white;padding: 12px;border-radius: 12px;">
                        <h2 style="margin-bottom:6px">{{ election.title }}</h2>
                        <p class="small">{{ election.description or '' }}</p>
                    </div>
                    {% for position_title, candidates in positions %}
                        <div class="position" data-position="{{ position_title }}" style="margin-top:18px;">
                            <div class="position-header">
                                <h1>{{ position_title }}</h1>
                                <h3>Select your choice(s) for this position</h3>
                            </div>
                            <div class="candidates">
                                {% for c in candidates %}
                                    <div class="candidate" data-candidate-id="{{ c.id }}" data-position="{{ position_title }}">
                                        <div class="voted" style="display:none;">
                                            <img src="{{ url_for('static', filename='images/check.png') }}" style="width: 20px; height: 20px;" alt="Voted">
                                            <span style="color: green; font-weight: bold;">Voted</span>
                                        </div>
                                        {% if c.photo_filename %}
                                            <img src="{{ url_for('static', filename='uploads/candidates/' + c.photo_filename) }}" style="width: 100px; height: 100px; border-radius: 50%;" alt="{{ c.full_name }}">
                                        {% else %}
                                            <img src="{{ url_for('static', filename='images/profile.png') }}" style="width: 100px; height: 100px; border-radius: 50%;" alt="{{ c.full_name }}">
                                        {% endif %}
                                        <h3>{{ c.full_name }}</h3>
                                        <h5>{{ c.party or '' }}</h5>
                                        <button class="vote-btn">Vote</button>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="background: rgba(255,255,255,0.95); padding: 18px; border-radius:12px;">
                    <h3>No candidates available for this election.</h3>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Floating Review Button -->
    <button class="review-btn" id="reviewVoteBtn">
        <img src="{{ url_for('static', filename='images/check.png') }}" alt="Review">
        Review Vote
    </button>

    <!-- Preview Modal -->
    <div id="previewModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center;">
        <div style="background:white; width:90%; max-width:800px; border-radius:12px; padding:18px; max-height:85%; overflow:auto;">
            <h2>Review your selections</h2>
            <div id="previewContent" style="margin-top:12px; display:flex; flex-direction:column; gap:12px;"></div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
                <button id="closePreview" class="btn btn--secondary">Back</button>
                <button id="submitPreview" class="btn btn--primary">Submit Votes</button>
            </div>
        </div>
    </div>

    <script>
        // Track selections: { positionTitle: candidateId }
        const selections = {};

        function markSelectedCard(cardEl, selected) {
            const voted = cardEl.querySelector('.voted');
            const voteBtn = cardEl.querySelector('.vote-btn');
                if (selected) {
                    if (voted) voted.style.display = 'flex';
                    if (voteBtn) { voteBtn.textContent = 'Cancel Vote'; voteBtn.style.backgroundColor = '#dc3545'; }
                } else {
                    if (voted) voted.style.display = 'none';
                    if (voteBtn) { voteBtn.textContent = 'Vote'; voteBtn.style.backgroundColor = '#28a745'; }
                }
        }

        // initialize buttons
        document.querySelectorAll('.candidate').forEach(card => {
            const btn = card.querySelector('.vote-btn');
            const position = card.getAttribute('data-position');
            const candidateId = card.getAttribute('data-candidate-id');

            // style primary green by default
            btn.style.backgroundColor = '#28a745';
            btn.style.color = '#fff';

            btn.addEventListener('click', () => {
                // single-choice per position: deselect any other in same position
                document.querySelectorAll(`.candidate[data-position="${position}"]`).forEach(other => {
                    if (other === card) return;
                    const otherId = other.getAttribute('data-candidate-id');
                    if (selections[position] && selections[position].toString() === otherId) {
                        delete selections[position];
                        markSelectedCard(other, false);
                    }
                });

                // toggle this selection
                if (selections[position] && selections[position].toString() === candidateId) {
                    delete selections[position];
                    markSelectedCard(card, false);
                } else {
                    selections[position] = parseInt(candidateId);
                    markSelectedCard(card, true);
                }
            });
        });

        // Review button
        document.getElementById('reviewVoteBtn').addEventListener('click', () => {
            openPreview();
        });

        function openPreview() {
            const preview = document.getElementById('previewModal');
            const content = document.getElementById('previewContent');
            content.innerHTML = '';

            // for each position, show selected candidate in same card design
            document.querySelectorAll('.position').forEach(pos => {
                const posTitle = pos.getAttribute('data-position');
                const wrapper = document.createElement('div');
                wrapper.style.background = '#f8f9fa';
                wrapper.style.padding = '10px';
                wrapper.style.borderRadius = '8px';
                const h = document.createElement('h3');
                h.textContent = posTitle;
                wrapper.appendChild(h);

                const selId = selections[posTitle];
                if (!selId) {
                    const p = document.createElement('div');
                    p.textContent = 'No selection';
                    p.className = 'small';
                    wrapper.appendChild(p);
                } else {
                    const card = pos.querySelector(`.candidate[data-candidate-id="${selId}"]`);
                    if (card) {
                        // clone a simplified card look
                        const clone = card.cloneNode(true);
                        clone.style.width = '100%';
                        clone.querySelector('.vote-btn').remove();
                        // ensure voted badge is visible
                        const voted = clone.querySelector('.voted');
                        if (voted) voted.style.display = 'flex';
                        wrapper.appendChild(clone);
                    }
                }
                content.appendChild(wrapper);
            });

            preview.style.display = 'flex';
        }

        document.getElementById('closePreview').addEventListener('click', () => {
            document.getElementById('previewModal').style.display = 'none';
        });

        document.getElementById('submitPreview').addEventListener('click', async () => {
            const btn = document.getElementById('submitPreview');
            btn.disabled = true;
            btn.textContent = 'Submitting...';

            const bodyEl = document.body;
            const submitUrl = bodyEl.getAttribute('data-submit-url');
            const selectUrl = bodyEl.getAttribute('data-select-url');
            const electionIdAttr = bodyEl.getAttribute('data-election-id');
            const electionId = electionIdAttr ? parseInt(electionIdAttr, 10) : null;

            const payload = { election_id: electionId, selections };

            try {
                const res = await fetch(submitUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    // close modal and show simple confirmation
                    document.getElementById('previewModal').style.display = 'none';
                    alert('Votes submitted successfully');
                    // optionally redirect back to select page
                    window.location.href = selectUrl;
                } else {
                    alert('Submission failed: ' + (data.message || res.statusText));
                }
            } catch (err) {
                alert('Submission error: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Submit Votes';
            }
        });
    </script>
</body>
</html>