<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        height: 100vh;
        background-image: url("{{ url_for('static', filename='images/admin-bg.png') }}");
        background-size: cover;
        background-position: center;
        background-attachment: fixed; /* keeps it frozen while scrolling */
    }
    .navbar {
        background-color: #333;
        color: white;
        height: 10vh;
        padding: 10px 20px;
        position: sticky;
        top: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .brand {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user {
        display: flex;
        align-items: center;
    }

    .main {
        display: flex;
        justify-content: center;
        padding: 20px;
        height: 90vh;
        gap: 20px;
    }

    .left {
        width: 20%;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .left a {
        padding: 15px 20px;
        text-decoration: none;
        background-color: white;
        color: black;
        border-radius: 15px;
    }

    .left a.active, .left a:hover {
        background-color: grey;
        color: white;
        font-weight: bold;
    }

    .right {
        width: 80%;
        height: 100%;
    }
    .candidates-list {
        background: white;
        height: 100%;
        border-radius: 10px;
        padding: 20px;
        overflow-y: auto;
    }
    /* Modal styles (shared look with elections modal) */
    .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 20px;
    }
    .modal[aria-hidden="false"] { display: flex; }
    .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.45); }
    .modal-panel {
        position: relative;
        background: #fff;
        max-width: 720px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        z-index: 2;
        padding: 18px 20px;
        max-height: 90vh;
        overflow-y: auto;
    }
    .modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .modal-header h2 { font-size: 1.1rem; }
    .close-btn { background: transparent; border: none; font-size:1.6rem; cursor:pointer; line-height:1; }
    .modal-form .form-row { margin-bottom: 12px; display:flex; flex-direction:column; }
    .modal-form label { margin-bottom:6px; font-weight:600; font-size:0.95rem; }
    .modal-form input[type="text"], .modal-form input[type="file"], .modal-form textarea, .modal-form select { padding:8px 10px; border-radius:6px; border:1px solid #ccc; font-size:0.95rem; }
    .modal-form textarea { resize: vertical; }
    .form-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:8px; }
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
    .btn-primary { background:#007bff; color:white; }
    .btn-secondary { background:#6c757d; color:white; }
    /* compact actions column */
    .actions-col { width: 140px; white-space: nowrap; text-align: center; }
    .actions-col a { display: inline-block; vertical-align: middle; }

    /* Shared table styles */
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table thead tr { background-color: #f4f4f4; }
    .data-table th, .data-table td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
    .data-table td { border-bottom: 1px solid #eee; }
    @media (max-width:640px) { .left { display:none; } .modal-panel { padding:12px; margin:0 8px; } }
</style>
<body>
    <div class="navbar">
        <div class="brand">
            <img src="{{ url_for('static', filename='images/logo.png') }}" style="width: 50px;" alt="Logo" class="logo">
            <div class="brand-name">
                <h3>Vicente Andaya Senior National High School</h3>
                <h4>Online Voting System</h4>
            </div>
        </div>
        <div class="user">
            <img src="{{ url_for('static', filename='images/profile.png') }}" style="width: 30px; border-radius: 50%;" alt="User" class="user-icon">
            <span class="username" style="margin-left: 10px; color: white;">John Doe</span>
            <div class="logout">
                <button style="padding: 10px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 15px;">
                    <img src="{{ url_for('static', filename='images/logout.png') }}" style="width: 16px; vertical-align: middle; margin-right: 5px;" alt="Logout Icon">
                    Logout
                </button>
            </div>
        </div>
    </div>
    <div class="main">
        <div class="left">
            <a href="{{ url_for('admin_dashboard') }}">Dashboard</a>
            <a href="{{ url_for('admin_voters') }}">Voters</a>
            <a href="{{ url_for('admin_elections') }}">Election</a>
            <a href="{{ url_for('admin_candidates') }}" class="active">Candidates</a>
            <a href="{{ url_for('admin_position') }}">Position</a>
            <a href="#">View Results</a>
            <a href="#">Printed Result</a>
        </div>
        <div class="right">
            <div class="candidates-list">
                <div style="display:flex; justify-content: flex-end; margin-bottom: 12px;">
                    <button id="openCandidateModal" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">Add Candidate</button>
                </div>
                <!-- Add Candidate Modal -->
                <div id="candidateModal" class="modal" aria-hidden="true">
                    <div class="modal-overlay" data-close></div>
                    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="candidateModalTitle">
                        <header class="modal-header">
                            <h2 id="candidateModalTitle">Add New Candidate</h2>
                            <button class="close-btn" id="closeCandidateModal" aria-label="Close modal">&times;</button>
                        </header>
                        <form id="candidateForm" method="post" action="{{ url_for('admin_create_or_update_candidate') }}" enctype="multipart/form-data" class="modal-form">
                            <input type="hidden" id="candidate_id" name="candidate_id" value="">
                            <div class="form-row">
                                <label for="full_name">Candidate Full Name</label>
                                <input type="text" id="full_name" name="full_name" required placeholder="Full name">
                            </div>
                            <div class="form-row">
                                <label for="photo">Candidate Photo</label>
                                <input type="file" id="photo" name="photo" accept="image/*">
                                <div id="photoPreview" style="margin-top:8px; display:none;"><img src="" alt="Preview" style="max-width:120px; border-radius:6px; border:1px solid #ddd;"></div>
                            </div>
                            <div class="form-row">
                                <label for="position">Position</label>
                                <select id="position" name="position" required>
                                    <option value="">-- Select Position --</option>
                                    {% if positions and positions|length > 0 %}
                                        {% for p in positions %}
                                            <option value="{{ p.title }}">{{ p.title }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="form-row">
                                <label for="party">Party / Affiliation</label>
                                <input type="text" id="party" name="party" placeholder="Party or team">
                            </div>
                            <div class="form-row">
                                <label for="bio">Short Biography / Description</label>
                                <textarea id="bio" name="bio" rows="4" placeholder="Short bio or notes"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" id="cancelCandidate">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Candidate</button>
                            </div>
                        </form>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Name</th>
                            <th>Team</th>
                            <th class="actions-col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if candidates and candidates|length > 0 %}
                            {% for c in candidates %}
                                <tr>
                                    <td>{{ c.position }}</td>
                                    <td>{{ c.full_name }}</td>
                                    <td>{{ c.party or '' }}</td>
                                    <td class="actions-col">
                                        <a href="#" class="btn-edit" data-id="{{ c.id }}" data-full_name="{{ c.full_name|e }}" data-position="{{ c.position|e }}" data-party="{{ c.party|e if c.party else '' }}" data-bio="{{ c.bio|e if c.bio else '' }}" data-photo="{{ c.photo_filename or '' }}" style="padding:6px 10px; background:#ffc107; color:#000; text-decoration:none; border-radius:5px; margin-right:6px;">Edit</a>
                                        <a href="#" class="btn-delete" data-id="{{ c.id }}" style="padding:6px 10px; background:#dc3545; color:#fff; text-decoration:none; border-radius:5px;">Delete</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="4">No candidates yet.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
<script>
    (function () {
        const openBtn = document.getElementById('openCandidateModal');
        const modal = document.getElementById('candidateModal');
        const closeBtn = document.getElementById('closeCandidateModal');
        const cancelBtn = document.getElementById('cancelCandidate');
        const overlay = document.querySelector('#candidateModal .modal-overlay');
        const form = document.getElementById('candidateForm');
        const photoInput = document.getElementById('photo');
        const photoPreviewWrap = document.getElementById('photoPreview');
        const photoPreviewImg = photoPreviewWrap && photoPreviewWrap.querySelector('img');

        function showModal() {
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
            setTimeout(() => document.getElementById('full_name').focus(), 50);
        }

        function hideModal() {
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
            // reset preview
            if (photoPreviewImg) { photoPreviewImg.src = ''; photoPreviewWrap.style.display = 'none'; }
            if (photoInput) { photoInput.value = ''; }
            form.reset();
        }

        openBtn && openBtn.addEventListener('click', showModal);
        closeBtn && closeBtn.addEventListener('click', hideModal);
        cancelBtn && cancelBtn.addEventListener('click', hideModal);
        overlay && overlay.addEventListener('click', hideModal);

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
                hideModal();
            }
        });

        if (photoInput) {
            photoInput.addEventListener('change', function () {
                const file = this.files && this.files[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    alert('Please select a valid image file.');
                    this.value = '';
                    return;
                }
                // optional size check: 5MB
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image is too large (max 5MB).');
                    this.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function (e) {
                    if (photoPreviewImg) {
                        photoPreviewImg.src = e.target.result;
                        photoPreviewWrap.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        form && form.addEventListener('submit', function (e) {
            // basic client-side validation
            const name = document.getElementById('full_name').value.trim();
            const position = document.getElementById('position').value;
            if (!name) {
                e.preventDefault(); alert('Candidate full name is required.'); return false;
            }
            if (!position) {
                e.preventDefault(); alert('Please select a position.'); return false;
            }
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Saving...'; }
        });

        // Edit buttons: populate modal with candidate data
        const candidateIdInput = document.getElementById('candidate_id');
        document.querySelectorAll('.btn-edit').forEach(function (btn) {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const fullName = this.getAttribute('data-full_name') || '';
                const position = this.getAttribute('data-position') || '';
                const party = this.getAttribute('data-party') || '';
                const bio = this.getAttribute('data-bio') || '';
                const photo = this.getAttribute('data-photo') || '';

                candidateIdInput.value = id;
                document.getElementById('full_name').value = fullName;
                document.getElementById('position').value = position;
                document.getElementById('party').value = party;
                document.getElementById('bio').value = bio;
                // show existing photo if available
                if (photo) {
                    if (photoPreviewImg) {
                        photoPreviewImg.src = '/static/uploads/candidates/' + photo;
                        photoPreviewWrap.style.display = 'block';
                    }
                } else {
                    if (photoPreviewImg) { photoPreviewImg.src = ''; photoPreviewWrap.style.display = 'none'; }
                }
                // change modal title and button
                const title = document.getElementById('candidateModalTitle');
                title.textContent = 'Edit Candidate';
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.textContent = 'Save Changes';
                showModal();
            });
        });

        // Delete modal implementation
        const deleteModal = document.createElement('div');
        deleteModal.innerHTML = `
        <div id="deleteCandidateModal" class="modal" aria-hidden="true">
            <div class="modal-overlay" data-close-delete></div>
            <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="deleteCandidateTitle">
                <header class="modal-header">
                    <h2 id="deleteCandidateTitle">Confirm Delete</h2>
                    <button class="close-btn" id="closeDeleteCandidateModal">&times;</button>
                </header>
                <p>Are you sure you want to delete this candidate? This action cannot be undone.</p>
                <form id="deleteCandidateForm" method="post" action="{{ url_for('admin_delete_candidate') }}" style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
                    <input type="hidden" id="delete_candidate_id" name="candidate_id" value="">
                    <button type="button" class="btn btn-secondary" id="cancelDeleteCandidate">Cancel</button>
                    <button type="submit" class="btn" style="background:#dc3545; color:#fff;">Delete</button>
                </form>
            </div>
        </div>`;
        document.body.appendChild(deleteModal);
        const deleteModalEl = document.getElementById('deleteCandidateModal');
        const deleteOverlay = deleteModalEl && deleteModalEl.querySelector('.modal-overlay');
        const closeDeleteBtn = document.getElementById('closeDeleteCandidateModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteCandidate');
        const deleteIdInput = document.getElementById('delete_candidate_id');

        document.querySelectorAll('.btn-delete').forEach(function (btn) {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                if (!id) return;
                deleteIdInput.value = id;
                deleteModalEl.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
            });
        });

        deleteOverlay && deleteOverlay.addEventListener('click', function () { deleteModalEl.setAttribute('aria-hidden', 'true'); document.body.style.overflow = ''; deleteIdInput.value = ''; });
        closeDeleteBtn && closeDeleteBtn.addEventListener('click', function () { deleteModalEl.setAttribute('aria-hidden', 'true'); document.body.style.overflow = ''; deleteIdInput.value = ''; });
        cancelDeleteBtn && cancelDeleteBtn.addEventListener('click', function () { deleteModalEl.setAttribute('aria-hidden', 'true'); document.body.style.overflow = ''; deleteIdInput.value = ''; });
    })();
</script>
</html>